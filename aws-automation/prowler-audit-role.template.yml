#
# Any code, applications, scripts, templates, proofs of concept, documentation
# and other items provided by AWS under this SOW are "AWS Content," as defined
# in the Agreement, and are provided for illustration purposes only. All such
# AWS Content is provided solely at the option of AWS, and is subject to the
# terms of the Addendum and the Agreement. Customer is solely responsible for
# using, deploying, testing, and supporting any code and applications provided
# by AWS under this SOW
#
AWSTemplateFormatVersion: 2010-09-09
Description: Create prowler Role inside an account.

Parameters:
  AutomationAccountId:
    Type: String
    Description: Name Account ID from where prowler will be executed and assume the required role.
    AllowedPattern: \d{12}
  ProwlerAuditRoleName:
    Type: String
    Description: Name for prowlers audit role. Needs to be defined as cross-account usage of prowler requires this.


Resources:
  ProwlerAuditRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref ProwlerAuditRoleName
      Path: /
      Description: Prowler's required Audit policies to check security status of AWS account.
      MaxSessionDuration: 14400 # 4 hours
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            AWS: !Ref AutomationAccountId
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/SecurityAudit
      Policies:
      - PolicyName: prowler-security-audit-addition-policy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Resource: "*"
            Action:
            - access-analyzer:List
            - apigateway:get
            - apigatewayv2:get
            - aws-marketplace:viewsubscriptions
            - batch:listjobs
            - clouddirectory:listappliedschemaarns
            - clouddirectory:listdevelopmentschemaarns
            - clouddirectory:listpublishedschemaarns
            - cloudformation:list
            - cloudhsm:listavailablezones
            - cloudsearch:list
            - cloudwatch:get
            - cloudwatch:list
            - codebuild:listbuilds
            - codestar:verify
            - cognito-identity:listidentities
            - cognito-idp:list
            - cognito-sync:listdatasets
            - connect:list
            - datapipeline:getaccountlimits
            - dax:describeclusters
            - dax:describedefaultparameters
            - dax:describeevents
            - dax:describeparametergroups
            - dax:describeparameters
            - dax:describesubnetgroups
            - dax:describetable
            - dax:listtables
            - devicefarm:list
            - discovery:list
            - dms:list
            - ds:ListAuthorizedApplications
            - ds:DescribeRoles
            - dynamodb:describebackup
            - dynamodb:describeglobaltablesettings
            - dynamodb:describelimits
            - dynamodb:describereservedcapacity
            - dynamodb:describereservedcapacityofferings
            - dynamodb:describestream
            - dynamodb:listtagsofresource
            - ec2:get
            - ecr:describe
            - ecr:listimages
            - elasticbeanstalk:listavailablesolutionstacks
            - elasticmapreduce:list
            - elastictranscoder:list
            - gamelift:list
            - glacier:list
            - importexport:listjobs
            - lambda:GetAccountSettings
            - lambda:GetFunctionConfiguration
            - lambda:GetLayerVersionPolicy
            - lambda:GetPolicy
            - lambda:List
            - lex:getbotaliases
            - lex:getbotchannelassociations
            - lex:getbots
            - lex:getbotversions
            - lex:getintents
            - lex:getintentversions
            - lex:getslottypes
            - lex:getslottypeversions
            - lex:getutterancesview
            - lightsail:getblueprints
            - lightsail:getbundles
            - lightsail:getinstancesnapshots
            - lightsail:getkeypair
            - lightsail:getregions
            - lightsail:getstaticips
            - lightsail:isvpcpeered
            - machinelearning:describe
            - mobilehub:listavailablefeatures
            - mobilehub:listavailableregions
            - mobilehub:listprojects
            - mobiletargeting:getapplicationsettings
            - mobiletargeting:getcampaigns
            - mobiletargeting:getimportjobs
            - mobiletargeting:getsegments
            - opsworks-cm:describe
            - opsworks:describe
            - polly:describe
            - polly:list
            - redshift:viewqueriesinconsole
            - route53domains:list
            - s3:listbucket
            - sdb:list
            - secretsmanager:listsecretversionids
            - servicecatalog:list
            - ses:list
            - ses:sendemail
            - sns:list
            - sqs:listqueuetags
            - ssm:listassociations
            - states:listactivities
            - support:describe
            - swf:list
            - tag:gettagkeys
            - trustedadvisor:describe
            - waf-regional:list
            - waf:list
            - workdocs:describeavailabledirectories
            - workdocs:describeinstances
            - workmail:describe
